<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何在 web 应用中使用 GDAL （三） | Yangholmes' blog</title>
    <meta name="description" content="blog">
    <meta name="generator" content="VitePress v1.6.4">
    <link rel="preload stylesheet" href="/assets/style.DjvLixjo.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.DJy1HGnA.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.Cc4yYURl.js">
    <link rel="modulepreload" href="/assets/chunks/theme.9sbxRX_t.js">
    <link rel="modulepreload" href="/assets/chunks/katex.ChWnQ-fc.js">
    <link rel="modulepreload" href="/assets/chunks/dagre-JOIXM2OF.DZMqaWVW.js">
    <link rel="modulepreload" href="/assets/chunks/c4Diagram-6F6E4RAY.DxBcFXqq.js">
    <link rel="modulepreload" href="/assets/chunks/flowDiagram-KYDEHFYC.Bdfh1AAD.js">
    <link rel="modulepreload" href="/assets/chunks/erDiagram-3M52JZNH.BHDGSlho.js">
    <link rel="modulepreload" href="/assets/chunks/gitGraphDiagram-GW3U2K7C.YoqqXcty.js">
    <link rel="modulepreload" href="/assets/chunks/ganttDiagram-EK5VF46D.DGVzBYxU.js">
    <link rel="modulepreload" href="/assets/chunks/infoDiagram-LHK5PUON.DXShuatg.js">
    <link rel="modulepreload" href="/assets/chunks/pieDiagram-NIOCPIFQ.DuvQgFrI.js">
    <link rel="modulepreload" href="/assets/chunks/quadrantDiagram-2OG54O6I.s37HuqSg.js">
    <link rel="modulepreload" href="/assets/chunks/xychartDiagram-H2YORKM3.CiFSnOsl.js">
    <link rel="modulepreload" href="/assets/chunks/requirementDiagram-QOLK2EJ7.D-TE_fHW.js">
    <link rel="modulepreload" href="/assets/chunks/sequenceDiagram-SKLFT4DO.5u1fgeZ3.js">
    <link rel="modulepreload" href="/assets/chunks/classDiagram-M3E45YP4.DGaXQtlC.js">
    <link rel="modulepreload" href="/assets/chunks/classDiagram-v2-YAWTLIQI.DGaXQtlC.js">
    <link rel="modulepreload" href="/assets/chunks/stateDiagram-MI5ZYTHO.BGDhI0fl.js">
    <link rel="modulepreload" href="/assets/chunks/stateDiagram-v2-5AN5P6BG.dMuurSbt.js">
    <link rel="modulepreload" href="/assets/chunks/journeyDiagram-EWQZEKCU.DH_oCqlM.js">
    <link rel="modulepreload" href="/assets/chunks/timeline-definition-MYPXXCX6.Csi-g0KC.js">
    <link rel="modulepreload" href="/assets/chunks/mindmap-definition-6CBA2TL7.CI_RhY5w.js">
    <link rel="modulepreload" href="/assets/chunks/kanban-definition-ZSS6B67P.Cz2T6TUI.js">
    <link rel="modulepreload" href="/assets/chunks/sankeyDiagram-4UZDY2LN.1C-uRJSo.js">
    <link rel="modulepreload" href="/assets/chunks/diagram-5UYTHUR4.-wLkLl5X.js">
    <link rel="modulepreload" href="/assets/chunks/diagram-ZTM2IBQH.s3sqBHhM.js">
    <link rel="modulepreload" href="/assets/chunks/blockDiagram-6J76NXCF.DspAtI5f.js">
    <link rel="modulepreload" href="/assets/chunks/architectureDiagram-SUXI7LT5.BBtKDzjL.js">
    <link rel="modulepreload" href="/assets/chunks/diagram-VMROVX33.BnjuUdV0.js">
    <link rel="modulepreload" href="/assets/chunks/virtual_mermaid-config.DDnGl6nM.js">
    <link rel="modulepreload" href="/assets/技术的小记_如何在 web 应用中使用 GDAL （三）_index.md.BQeKI2oQ.lean.js">
    <link rel="icon" type="image/x-icon" href="/icon.png">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body><!--teleport start anchor--><div class="overlay" data-v-5374f614></div><!--teleport anchor-->
    <div id="app"><div class="main-layout" data-v-2f151704><div class="left-side" data-v-2f151704><div class="sidebar" data-v-2f151704 data-v-5374f614><div class="mobile-only handler" data-v-5374f614 data-v-ca29c581 data-v-8a8dc170><!--[--><div class="toggle-handler" data-v-ca29c581><span class="vpi-chevron-right icon" data-v-ca29c581></span></div><!--]--></div><div class="top-bar" data-v-5374f614><div class="theme-switch is-dark" data-v-5374f614 data-v-6427e52d><div class="round-button switch sun" data-v-6427e52d data-v-d3afb744><span class="vpi-sun icon" data-v-d3afb744></span></div><div class="round-button switch moon" data-v-6427e52d data-v-d3afb744><span class="vpi-moon icon" data-v-d3afb744></span></div></div><div class="VPNavBarSearch plugin search" data-v-5374f614 data-v-d17e8928><!----><div id="docsearch"><!--[--><div class="round-button" data-v-d17e8928 data-v-d3afb744><span class="vpi-search icon" data-v-d3afb744></span></div><!--]--></div></div></div><nav data-v-5374f614><div class="avatar" data-v-5374f614 data-v-d3b92462><a href="/" data-v-d3b92462><div class="image" style="--image: url(/assets/cats.BfteQRM1.png)" data-v-d3b92462></div></a><p data-v-d3b92462>Yangholmes</p><p data-v-d3b92462> 邋遢和小松的 <ruby data-v-d3b92462>铲<rt data-v-d3b92462>chǎn</rt></ruby><ruby data-v-d3b92462>屎<rt data-v-d3b92462>shǐ</rt></ruby><ruby data-v-d3b92462>官<rt data-v-d3b92462>guān</rt></ruby></p></div><ul class="category-list" data-v-5374f614><!--[--><li class="active" data-v-5374f614><a href="/技术的小记/" data-v-5374f614>技术的小记</a></li><li class="" data-v-5374f614><a href="/派的玩耍小记/" data-v-5374f614>派的玩耍小记</a></li><li class="" data-v-5374f614><a href="/生活咏叹调/" data-v-5374f614>生活咏叹调</a></li><!--]--></ul><ul class="socials" data-v-5374f614 data-v-fb1a9594><!--[--><li data-v-fb1a9594><a href="https://github.com/Yangholmes" target="_blank" rel="noopener noreferrer" data-v-fb1a9594><div class="social-icon" style="--mask-image: "></div></a></li><li data-v-fb1a9594><a href="https://dev.to/yangholmes" target="_blank" rel="noopener noreferrer" data-v-fb1a9594><div class="social-icon" style="--mask-image: "></div></a></li><li data-v-fb1a9594><a href="https://www.instagram.com/yangholmes/" target="_blank" rel="noopener noreferrer" data-v-fb1a9594><div class="social-icon" style="--mask-image: "></div></a></li><li data-v-fb1a9594><a href="/wechat-qrcode.png" target="_blank" rel="noopener noreferrer" data-v-fb1a9594><div class="social-icon" style="--mask-image: "></div></a></li><!--]--></ul></nav><div class="bottom-bar" data-v-5374f614></div><!--teleport start--><!--teleport end--></div></div><main class="content" data-v-2f151704><div class="nav-bar" data-v-2f151704 data-v-22de979f><div class="round-button" data-v-22de979f data-v-d3afb744><span class="vpi-arrow-left icon" data-v-d3afb744></span></div></div><div class="page" data-v-2f151704 data-v-d8a24893><div class="vp-doc" data-v-d8a24893><div style="position:relative;" data-v-d8a24893><div><h1 id="如何在-web-应用中使用-gdal-三" tabindex="-1">如何在 web 应用中使用 GDAL （三） <a class="header-anchor" href="#如何在-web-应用中使用-gdal-三" aria-label="Permalink to &quot;如何在 web 应用中使用 GDAL （三）&quot;">​</a></h1><p><strong>2025/08/18</strong></p><nav class="table-of-contents"><ul><li><a href="#优化的必要性">优化的必要性</a></li><li><a href="#如何优化">如何优化</a><ul><li><a href="#代码分离">代码分离</a></li><li><a href="#按需编译">按需编译</a></li><li><a href="#调试信息">调试信息</a></li><li><a href="#运行环境设置">运行环境设置</a></li><li><a href="#文件系统">文件系统</a></li><li><a href="#其他">其他</a></li></ul></li><li><a href="#实战">实战</a><ul><li><a href="#gdal3-js-编译脚本纠错">gdal3.js 编译脚本纠错</a></li><li><a href="#gdal3-js-编译脚本优化">gdal3.js 编译脚本优化</a></li><li><a href="#结果">结果</a></li></ul></li><li><a href="#结语">结语</a></li></ul></nav><p>这篇研究优化。</p><h2 id="优化的必要性" tabindex="-1">优化的必要性 <a class="header-anchor" href="#优化的必要性" aria-label="Permalink to &quot;优化的必要性&quot;">​</a></h2><p>上上篇介绍了一个完整的<a href="https://github.com/bugra9/gdal3.js/blob/master/Makefile" target="_blank" rel="noreferrer">编译脚本</a>，运行这个脚本可以顺利编译出 GDAL WebAssembly 版本的产物。</p><p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4pq5z0b1xx6lz5ahztul.png" alt="GDAL 编译产物"></p><p>但是这个编译结果并不适合在生产环境中使用，原因有：</p><ol><li>文件太大，核心 wasm 文件 27MB ，胶水代码 272KB ，data 文件 11 MB</li><li>胶水代码大量冗余，包含 Node 环境、bash 环境的代码，且无法进行 tree shaking</li><li>生产环境无需输出调试信息</li></ol><p>其中文件过大是最致命的，构建产物全部加起来超过 38MB ，任何 web 应用都无法接受这么一个硕大文件依赖的模块。</p><p>另外，这个 Makefile 包含许多错误配置，由于 emsdk 在编译时会抛弃不支持的编译配置，这些错误并没有中断编译。本篇还将尝试解读 gdal3.js 作者的意图，修正错误的编译参数。</p><blockquote><p>先叠甲</p><p>通过编译过程优化，GDAL 3.x 版本的 WebAssembly 编译产物可以缩小，但很难做到足够小。本篇介绍的操作对于编译 GDAL 2.x 和 OpenCV 4.x 非常有效。个中原因，需要了解 GDAL 的源码和编译机制才能分晓，已超出本系列范围，先按下不表。</p><p>TODO: 添加 OpenCV 的优化对比</p></blockquote><h2 id="如何优化" tabindex="-1">如何优化 <a class="header-anchor" href="#如何优化" aria-label="Permalink to &quot;如何优化&quot;">​</a></h2><p>对于 web 应用来说，资源越小越好。经典的 web 开发流程中，开发者使用现代化的前端构建工具和模块化设计，通过注入懒加载、Tree-Shaking 等方法把原本可能比较大的 JavaScript 文件缩小成比较小的文件，并且可以做到按需要加载；JavaScript 以外的文件，使用各种“加载器”转换成 JavaScript 代码的样子，也可以实现构建和优化。但这些手段在 WebAssembly 面前都不起作用了：</p><ol><li>加载器的原理是将非 *.js 文件转换成 JavaScript 模块，例如将 *.png 文件转换为 base64 字符串或 url 字符串并导出为模块；转换的过程中可以缩小文件，依赖于这种文件的压缩算法，压缩后的文件必须保证在不增加代码的前提下能够在客户端中使用； *.wasm 文件可以压缩，但是目前还无法做到客户端中不增加代码就能使用</li><li>JavaScript Tree-Shaking 是基于字符串代码抽象语法树去除死代码，*.wasm 是已经编译好的可执行文件，是二进制代码不是字符串，无法像 JavaScript 一样瘦身</li></ol><blockquote><p>能不能做一个 <code>*.wasm</code> 文件的 loader 呢？有的，其实是有的，比如说 <a href="https://vite.dev/guide/features.html#webassembly" target="_blank" rel="noreferrer">vite</a> 就可以使用 <code>?init</code> 直接加载 WebAssembly 模块并初始化，省去写拉取初始化等代码的过程，但是这个写法并不适合结合胶水代码。</p></blockquote><p>既然如此，我们应该着眼于 wasm 编译阶段的优化。</p><h3 id="代码分离" tabindex="-1">代码分离 <a class="header-anchor" href="#代码分离" aria-label="Permalink to &quot;代码分离&quot;">​</a></h3><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">WASM</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>有三个选项</p><ul><li>0 - 生成 asm.js ，wasm 代码和 js 代码合二为一</li><li>1 - wasm 代码和 js 代码分开输出</li><li>2 - 同时生成 asm.js 和 wasm + js</li></ul><h3 id="按需编译" tabindex="-1">按需编译 <a class="header-anchor" href="#按需编译" aria-label="Permalink to &quot;按需编译&quot;">​</a></h3><blockquote><p>“用多少编多少”</p></blockquote><h4 id="_1-库函数" tabindex="-1">1. 库函数 <a class="header-anchor" href="#_1-库函数" aria-label="Permalink to &quot;1. 库函数&quot;">​</a></h4><p>通常在项目中，我们只会用到算法库中占整个库很小比例的若干几个功能，没有必要编译无用的功能；编译 C/C++ 项目时，编译器通常会自动消除死代码，可以通过以下两个参数控制：</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXPORTED_FUNCTIONS  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 导出函数列表</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXPORT_ALL  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 导出所有函数</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>注意，导出函数前面需要添加一个下划线 <code>_</code> ，例如需要导出 <code>add</code> 函数，可以这样编写</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-sEXPORTED_FUNCTIONS=&quot;[&#39;_add&#39;]&quot;&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_2-emscripten-运行时函数" tabindex="-1">2. emscripten 运行时函数 <a class="header-anchor" href="#_2-emscripten-运行时函数" aria-label="Permalink to &quot;2. emscripten 运行时函数&quot;">​</a></h4><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXPORTED_RUNTIME_METHODS</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>emscripten 运行时函数，默认值是空数组。我们应该按照实际需要添加导出函数，比如需要使用虚拟文件系统时，添加 <code>FS</code> 到数组中</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-sEXPORTED_RUNTIME_METHODS=&quot;[&#39;FS&#39;]&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>在 <a href="https://github.com/bugra9/gdal3.js/blob/master/Makefile" target="_blank" rel="noreferrer">gdal3.js</a> 项目中，导出函数列表将几乎所有支持的 GDAL 功能都列进去了，这是编译产物巨大化的关键原因。</p><h3 id="调试信息" tabindex="-1">调试信息 <a class="header-anchor" href="#调试信息" aria-label="Permalink to &quot;调试信息&quot;">​</a></h3><p>emcc 编译参数和 gcc 的大致相同，可以选择关闭生产环境中的调试信息来优化产物。和调试信息相关的配置有</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-gsource-map</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-source-map-base</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-O&lt;level&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">-g&lt;level&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_1-gsource-map-和-source-map-base" tabindex="-1">1. <code>-gsource-map</code> 和 <code>-source-map-base</code> <a class="header-anchor" href="#_1-gsource-map-和-source-map-base" aria-label="Permalink to &quot;1. `-gsource-map` 和 `-source-map-base`&quot;">​</a></h4><p><code>-gsource-map</code> 控制是否输出 sourcemap ，如果设置了输出 sourcemap ，调试器将会在 <code>&lt;base-url&gt;</code> + <code>&lt;wasm-file-name&gt;</code> + <code>.map</code> 位置加载 .map 文件，<code>&lt;base-url&gt;</code> 由参数 <code>-source-map-base</code> 设置，默认为空，也就是和 wasm 文件同一个路径。</p><h4 id="_2-o-level" tabindex="-1">2. <code>-O&lt;level&gt;</code> <a class="header-anchor" href="#_2-o-level" aria-label="Permalink to &quot;2. `-O&lt;level&gt;`&quot;">​</a></h4><p>设置优化等级。</p><ul><li><code>-O0</code> - 完全不优化，保留所有调试信息</li><li><code>-O1</code> - 基础优化，消除运行时断言</li><li><code>-O2</code> - <code>-O1</code> 基础上进一步优化，消除死代码</li><li><code>-O3</code> - <code>-O2</code> 基础上再优化</li><li><code>-Og</code> - 和 <code>-O1</code> 差不多，比 <code>-O1</code> 保留更多调试信息</li><li><code>-Os</code> - 和 <code>-O3</code> 差不多，比 <code>-O3</code> 输出文件更小</li><li><code>-Oz</code> - 和 <code>-Os</code> 差不多，比 <code>-Os</code> 输出文件更小</li></ul><p>默认值是 <code>-O0</code> ，保留所有调试信息。</p><h4 id="_3-g-level" tabindex="-1">3. <code>-g&lt;level&gt;</code> <a class="header-anchor" href="#_3-g-level" aria-label="Permalink to &quot;3. `-g&lt;level&gt;`&quot;">​</a></h4><p>调试等级，一共有四个等级</p><ul><li><code>-g0</code> - 不输出任何调试信息</li><li><code>-g1</code> - 链接时，保留 JavaScript 中的空格</li><li><code>-g2</code> - 链接时，保留编译代码中的函数名称</li><li><code>-g3</code> - 编译为目标文件时，保留调试信息，包括 JS 空格、函数名称和 LLVM 调试信息（DWARF）（如果有的话）</li></ul><p>如果设置为 <code>-g</code> 不带有任何数字，相当于 <code>-g3</code> 。</p><h3 id="运行环境设置" tabindex="-1">运行环境设置 <a class="header-anchor" href="#运行环境设置" aria-label="Permalink to &quot;运行环境设置&quot;">​</a></h3><p>默认情况下，emscripten 认为胶水代码会在不同的环境中执行，自动生成各种环境的嗅探代码和初始化代码。实际上，对于一个确定的应用而言，运行环境是固定的，没有必要产出环境嗅探。运行环境的参数是</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ENVIRONMENT</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>emscripten 支持的值有：</p><ul><li>node - Node.js</li><li>web - 网页</li><li>webview - 也是网页，特指插入 native 应用的网页，等同于 web</li><li>worker - worker 环境</li><li>shell - 命令行中</li></ul><p>如果是 web 应用，只需要编译 <code>-sENVIRONMENT=worker</code> 环境即可；同理，在 Node.js 环境中只需要编译 <code>-sENVIRONMENT=node</code> 。</p><p>还有一个与运行环境相关的配置项是</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">EXPORT_ES6</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>将这个配置设置为 <code>1</code> ，便可以把胶水代码输出为符合 esmodule 规范的模块。默认情况下，胶水代码输出包含环境嗅探的 CommonJS 模块和 IIFE ，在现代前端项目中无法使用 <code>import</code> 导入。</p><h3 id="文件系统" tabindex="-1">文件系统 <a class="header-anchor" href="#文件系统" aria-label="Permalink to &quot;文件系统&quot;">​</a></h3><p>某些算法库，如 GDAL ，需要依赖操作系统的文件系统读写文件和输出输出，emscripten 实现了一套基于 JavaScript 的内存文件系统。如果项目中没有使用文件系统，可以不使用，配置文件系统的参数是</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FILESYSTEM</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>编译文件系统，如果代码引用了 stdio.h 和 fprintf ，会自动开启，如果代码是纯计算，可以手动关闭。</p><blockquote><p>emscripten 的文件系统随 Module 导出，可以通过 <code>Module.FS</code> 访问</p></blockquote><h3 id="其他" tabindex="-1">其他 <a class="header-anchor" href="#其他" aria-label="Permalink to &quot;其他&quot;">​</a></h3><h4 id="_1-polyfill" tabindex="-1">1. polyfill <a class="header-anchor" href="#_1-polyfill" aria-label="Permalink to &quot;1. polyfill&quot;">​</a></h4><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">POLYFILL</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>是否添加 polyfill 支持旧版浏览器，默认值是 <code>true</code> 。一般需要支持旧版浏览器的项目，都会在统一的地方添加 polyfill ，无需 emscripten 再添加，建议关闭 polyfill 。</p><h4 id="_2-使用-bom-的-math-库" tabindex="-1">2. 使用 BOM 的 Math 库 <a class="header-anchor" href="#_2-使用-bom-的-math-库" aria-label="Permalink to &quot;2. 使用 BOM 的 Math 库&quot;">​</a></h4><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">JS_MATH</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>可以配置这个参数为 <code>true</code> 使用 JavaScript Math 库，这样就可以避免编译 libc 。如果使用 JavaScript Math 库，计算的结果可能和 libc math 库精度不一致。建议在对精度不是很敏感的项目中可以开启。</p><h4 id="_3-最小化输出" tabindex="-1">3. 最小化输出 <a class="header-anchor" href="#_3-最小化输出" aria-label="Permalink to &quot;3. 最小化输出&quot;">​</a></h4><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MINIMAL_RUNTIME</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>最小化输出，不带 POSIX 功能，不带 Module ，也不带 emscripten 内置的 XHR 等模块。尽管可以获得非常小的产物，但是可能代码无法运行，不建议使用。</p><h2 id="实战" tabindex="-1">实战 <a class="header-anchor" href="#实战" aria-label="Permalink to &quot;实战&quot;">​</a></h2><h3 id="gdal3-js-编译脚本纠错" tabindex="-1">gdal3.js 编译脚本纠错 <a class="header-anchor" href="#gdal3-js-编译脚本纠错" aria-label="Permalink to &quot;gdal3.js 编译脚本纠错&quot;">​</a></h3><h4 id="_1-调试等级错误" tabindex="-1">1. 调试等级错误 <a class="header-anchor" href="#_1-调试等级错误" aria-label="Permalink to &quot;1. 调试等级错误&quot;">​</a></h4><p>FLAGS 文件<a href="https://github.com/bugra9/gdal3.js/blob/v2.8.1/GDAL_EMCC_FLAGS.mk#L4" target="_blank" rel="noreferrer">第 4 行</a> 定义调试等级，emcc 支持参数 0~3 ，并不支持 <code>-g4</code>。</p><p>这里明显可以看出来，当 <code>type</code> 参数为 <code>debug</code> 时，编译输出完整的调试信息。所以这里应该使用</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GDAL_EMCC_FLAGS += -O0 -g3`</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_2-sourcemap-设置错误" tabindex="-1">2. sourcemap 设置错误 <a class="header-anchor" href="#_2-sourcemap-设置错误" aria-label="Permalink to &quot;2. sourcemap 设置错误&quot;">​</a></h4><p>还是在同一行，配置了 <code>--source-map-base</code> ，但并未开启 <code>-gsource-map</code> 。这里同样是当 <code>type</code> 参数为 <code>debug</code> 时，需要编译完整的 sourcemap 方便跟踪调试， <code>--source-map-base</code> 建议从参数中读取，所以这里应该使用</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GDAL_EMCC_FLAGS += -gsource-map=1 --source-map-base </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">BASE_URL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="gdal3-js-编译脚本优化" tabindex="-1">gdal3.js 编译脚本优化 <a class="header-anchor" href="#gdal3-js-编译脚本优化" aria-label="Permalink to &quot;gdal3.js 编译脚本优化&quot;">​</a></h3><h4 id="_1-关闭所有调试信息" tabindex="-1">1. 关闭所有调试信息 <a class="header-anchor" href="#_1-关闭所有调试信息" aria-label="Permalink to &quot;1. 关闭所有调试信息&quot;">​</a></h4><p>FLAGS 文件<a href="https://github.com/bugra9/gdal3.js/blob/v2.8.1/GDAL_EMCC_FLAGS.mk#L6" target="_blank" rel="noreferrer">第 6 行</a> 增加关闭调试的配置</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GDAL_EMCC_FLAGS += -Oz -g0</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_2-指定运行环境" tabindex="-1">2. 指定运行环境 <a class="header-anchor" href="#_2-指定运行环境" aria-label="Permalink to &quot;2. 指定运行环境&quot;">​</a></h4><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GDAL_EMCC_FLAGS += -s ENVIRONMENT=worker -s EXPORT_ES6=1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h4 id="_3-减少导出函数" tabindex="-1">3. 减少导出函数 <a class="header-anchor" href="#_3-减少导出函数" aria-label="Permalink to &quot;3. 减少导出函数&quot;">​</a></h4><p>例如上一篇，我们在代码中值用到了 <code>GDALOpen</code> 、 <code>GDALInfo</code> 和 <code>GDALClose</code> ，那么我们就只导出这三个函数：</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GDAL_EMCC_FLAGS += -s EXPORTED_FUNCTIONS=&quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;_malloc&#39;,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;_free&#39;,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;_CSLCount&#39;,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;_GDALOpen&#39;,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;_GDALClose&#39;,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;_GDALInfo&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>emscripten 提供的运行时函数也不需要太多，只导出用得上的：</p><div class="language-makefile vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">GDAL_EMCC_FLAGS += -s EXPORTED_RUNTIME_METHODS=&quot;[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;ccall&#39;,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;cwrap&#39;,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &#39;FS&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="结果" tabindex="-1">结果 <a class="header-anchor" href="#结果" aria-label="Permalink to &quot;结果&quot;">​</a></h3><p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/42xw0fgo2xmmjwkfn4ke.png" alt="优化结果"></p><p>wasm 文件减小了 6177075Bytes ，瘦身了 22.44% ； js 文件减小了 18299Bytes ，瘦身 10.21% 。</p><h2 id="结语" tabindex="-1">结语 <a class="header-anchor" href="#结语" aria-label="Permalink to &quot;结语&quot;">​</a></h2><p>后面的篇章我们将会讨论：</p><ol><li>emscripten 的虚拟文件系统</li><li>*.data 是什么，有什么用，如何优化 *.data</li></ol></div></div></div><div data-v-d8a24893></div><div class="footer" data-v-d8a24893 data-v-7d1942f1><p data-v-7d1942f1> © 2017 ~ 2025 • Yangholmes </p><p class="driver" data-v-7d1942f1> 使用 ❤️ <a href="https://vitepress.dev/" target="_blank" data-v-7d1942f1>Vitepress</a> 搭建 - Yangholmes 提供主题 </p></div></div></main></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"index.md\":\"CP9Hi_7f\",\"技术的小记_atom 改装指南_index.md\":\"B4_dRgst\",\"技术的小记_extjs 自定义 datetimefield 控件_index.md\":\"CbD649Nd\",\"技术的小记_google 地图 tms 服务参数解析_index.md\":\"Mk7cGrnL\",\"技术的小记_index.md\":\"DWGaN_mI\",\"技术的小记_javascript 变量类型判断_index.md\":\"DpjfUKMW\",\"技术的小记_javascript 隐式转换_index.md\":\"ReFuhecV\",\"技术的小记_javascript 隐式转换_mermaid.md\":\"CclN1vIM\",\"技术的小记_javascript 隐式转换_mindmap-en.md\":\"CNKrHJHm\",\"技术的小记_javascript 隐式转换_mindmap.md\":\"DiYL_xVf\",\"技术的小记_photoshop 基础--如何抠图_index.md\":\"9v6qUhrD\",\"技术的小记_web 应用榨干 cpu 性能的正确姿势_index.md\":\"Bxb5Zhcs\",\"技术的小记_什么是原型链_index.md\":\"-HxJqH6C\",\"技术的小记_如何为 vue 组件提供 slots 静态类型检查_index.md\":\"Ba_fchbm\",\"技术的小记_如何在 web 应用中使用 gdal （一）_index.md\":\"BLkjo2af\",\"技术的小记_如何在 web 应用中使用 gdal （三）_index.md\":\"BQeKI2oQ\",\"技术的小记_如何在 web 应用中使用 gdal （二）_index.md\":\"CDZxYblf\",\"技术的小记_如何设计一个 brainfuck 解释器_index.md\":\"WSwCM4eH\",\"技术的小记_如何设计一个易用的tag组件_index.md\":\"oUoSl_8u\",\"技术的小记_脚本化css_index.md\":\"aC3Daoyf\",\"派的玩耍小记_c 的 main 函数_index.md\":\"DdjK9d6y\",\"派的玩耍小记_gcc 的编译过程_index.md\":\"mUOpWjH1\",\"派的玩耍小记_index.md\":\"zhpoBeio\",\"派的玩耍小记_orangepi lite 2 刷 ubuntu 18.04.4 方法_index.md\":\"KMU_1Y1i\",\"派的玩耍小记_新到的玩具_index.md\":\"Dm5FSJmx\",\"派的玩耍小记_驱动步进电机_index.md\":\"CdeY13lR\",\"生活咏叹调_index.md\":\"CAdurxHp\",\"生活咏叹调_两个和尚的故事_index.md\":\"DEpi9XPp\",\"生活咏叹调_我居然想变老_index.md\":\"BmygRtQg\",\"生活咏叹调_生命_index.md\":\"nWF96alk\",\"生活咏叹调_生活宝鉴_index.md\":\"BMx2Jaqc\",\"生活咏叹调_顽强的绿萝_index.md\":\"C1aa67Wx\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-cn\",\"dir\":\"ltr\",\"title\":\"Yangholmes' blog\",\"description\":\"blog\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"categories\":[\"技术的小记\",\"派的玩耍小记\",\"生活咏叹调\"],\"posts\":{\"技术的小记\":[{\"title\":\"如何在 web 应用中使用 GDAL （三）\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/如何在 web 应用中使用 GDAL （三）\",\"createDate\":\"2025/08/18\",\"excerpt\":\"\"},{\"title\":\"JavaScript 隐式转换\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/JavaScript 隐式转换\",\"createDate\":\"2025/08/13\",\"excerpt\":\"\"},{\"title\":\"如何在 web 应用中使用 GDAL （二）\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/如何在 web 应用中使用 GDAL （二）\",\"createDate\":\"2025/08/10\",\"excerpt\":\"\"},{\"title\":\"如何在 web 应用中使用 GDAL （一）\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/如何在 web 应用中使用 GDAL （一）\",\"createDate\":\"2025/08/04\",\"excerpt\":\"\"},{\"title\":\"JavaScript 变量类型判断\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/JavaScript 变量类型判断\",\"createDate\":\"2025/07/12\",\"excerpt\":\"\"},{\"title\":\"如何为 Vue 组件提供 slots 静态类型检查\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/如何为 Vue 组件提供 slots 静态类型检查\",\"createDate\":\"2025/05/28\",\"excerpt\":\"\"},{\"title\":\"google 地图 TMS 服务参数解析\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/google 地图 TMS 服务参数解析\",\"createDate\":\"2023/08/17\",\"excerpt\":\"\"},{\"title\":\"web 应用榨干 CPU 性能的正确姿势\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/web 应用榨干 CPU 性能的正确姿势\",\"createDate\":\"2021/09/03\",\"excerpt\":\"\"},{\"title\":\"什么是原型链\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/什么是原型链\",\"createDate\":\"2021/01/13\",\"excerpt\":\"\"},{\"title\":\"Atom 改装指南\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/Atom 改装指南\",\"createDate\":\"2018/06/22\",\"excerpt\":\"\"},{\"title\":\"如何设计一个 BrainFuck 解释器\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/如何设计一个 BrainFuck 解释器\",\"createDate\":1526860800000,\"excerpt\":\"\"},{\"title\":\"如何设计一个易用的tag组件\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/如何设计一个易用的tag组件\",\"createDate\":1526342400000,\"excerpt\":\"\"},{\"title\":\"PhotoShop 基础--如何抠图\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/PhotoShop 基础--如何抠图\",\"createDate\":\"2016/06/04\",\"excerpt\":\"\"},{\"title\":\"脚本化CSS\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/脚本化CSS\",\"createDate\":\"2016/05/09\",\"excerpt\":\"\"},{\"title\":\"ExtJS 自定义 datetimefield 控件\",\"category\":\"技术的小记\",\"url\":\"/技术的小记/ExtJS 自定义 datetimefield 控件\",\"createDate\":\"2016/05/07\",\"excerpt\":\"\"}],\"派的玩耍小记\":[{\"title\":\"OrangePi Lite 2 刷 Ubuntu 18.04.4 方法\",\"category\":\"派的玩耍小记\",\"url\":\"/派的玩耍小记/OrangePi Lite 2 刷 Ubuntu 18.04.4 方法\",\"createDate\":\"2020/05/03\",\"excerpt\":\"\"},{\"title\":\"驱动步进电机\",\"category\":\"派的玩耍小记\",\"url\":\"/派的玩耍小记/驱动步进电机\",\"createDate\":\"2019/11/23\",\"excerpt\":\"\"},{\"title\":\"C 的 main 函数\",\"category\":\"派的玩耍小记\",\"url\":\"/派的玩耍小记/C 的 main 函数\",\"createDate\":\"2019/10/27\",\"excerpt\":\"\"},{\"title\":\"gcc 的编译过程\",\"category\":\"派的玩耍小记\",\"url\":\"/派的玩耍小记/gcc 的编译过程\",\"createDate\":\"2019/10/27\",\"excerpt\":\"\"},{\"title\":\"新到的玩具\",\"category\":\"派的玩耍小记\",\"url\":\"/派的玩耍小记/新到的玩具\",\"createDate\":1572019200000,\"excerpt\":\"\"}],\"生活咏叹调\":[{\"title\":\"生活宝鉴\",\"category\":\"生活咏叹调\",\"url\":\"/生活咏叹调/生活宝鉴\",\"createDate\":\"2021/05/09\",\"excerpt\":\"\"},{\"title\":\"两个和尚的故事\",\"category\":\"生活咏叹调\",\"url\":\"/生活咏叹调/两个和尚的故事\",\"createDate\":\"2021/02/26\",\"excerpt\":\"\"},{\"title\":\"顽强的绿萝\",\"category\":\"生活咏叹调\",\"url\":\"/生活咏叹调/顽强的绿萝\",\"createDate\":\"2020/11/19\",\"excerpt\":\"\"},{\"title\":\"生命\",\"category\":\"生活咏叹调\",\"url\":\"/生活咏叹调/生命\",\"createDate\":\"2020/11/18\",\"excerpt\":\"\"},{\"title\":\"我居然想变老\",\"category\":\"生活咏叹调\",\"url\":\"/生活咏叹调/我居然想变老\",\"createDate\":\"2020/11/17\",\"excerpt\":\"\"}]},\"lastUpdated\":true,\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/Yangholmes\"},{\"icon\":\"dev\",\"link\":\"https://dev.to/yangholmes\"},{\"icon\":\"instagram\",\"link\":\"https://www.instagram.com/yangholmes/\"},{\"icon\":\"wechat\",\"link\":\"/wechat-qrcode.png\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  <script type="text/javascript">
          (function(c,l,a,r,i,t,y){
              c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
              t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
              y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
          })(window, document, "clarity", "script", "sqwvxx7phf");
        </script></body>
</html>