{"version":3,"file":"Settings-CC6nM4kY.js","sources":["../../src/pages/settings/Settings.tsx"],"sourcesContent":["/**\n * @file settings list\n * @author Yangholmes 2025-03-18\n */\n\nimport { defineComponent, onMounted, ref } from 'vue';\nimport { useI18n } from 'vue-i18n';\nimport cn from 'classnames';\nimport useSettingsStore from '@/stores/settings';\n\nimport BasicLayout from '../layout/BasicLayout';\nimport BasicTopBar from '../layout/BasicTopBar';\nimport DoubleDeckerContainer from '@/components/doubleDeckerContainer/DoubleDeckerContainer';\nimport DeckerLayout from '../layout/DeckerLayout';\nimport SvgIcon from '@/components/svgIcon/SvgIcon';\n\nimport { NButton, useDialog, useMessage } from 'naive-ui';\n\nimport db from '@/services/db';\nimport { Setting } from '@/services/db/web/settings/db';\nimport { getControl, needOpenDecker, renderValue } from './utils';\nimport { deepToRaw } from '../vue-utils';\nimport { settingCatogory } from './config';\n\nimport styles from './settings.module.less';\nimport { JSX } from 'vue/jsx-runtime';\n\nexport default defineComponent({\n  name: 'Settings',\n  setup() {\n    const { updateSettingMap } = useSettingsStore();\n    const { t } = useI18n({ useScope: 'global' });\n\n    const message = useMessage();\n    const dialog = useDialog();\n\n    const allSettings = ref<Setting[][]>([]);\n\n    const selectedCatogoryIndex = ref<number>();\n    const selectedSetting = ref<Setting>();\n\n    const init = () => {\n      return Promise.all(settingCatogory.map(catogory => db.settings.getSettingsByCategory(catogory))).then(res => {\n        allSettings.value = res;\n      });\n    };\n\n    onMounted(() => {\n      init();\n    });\n\n    const saveSetting = (setting: Setting) => {\n      const { key, value } = setting;\n      return db.settings.updateSettingByKey(key, value).then(() => {\n        message.success(t('pages.settings.decker.topbar.saveSuccess'));\n        updateSettingMap(key, value);\n      }).catch(() => {\n        message.error(t('pages.settings.decker.topbar.saveFailed'));\n        init();\n      });\n    };\n\n    const renderSettingControl = (back: () => void) => {\n      console.log(selectedSetting);\n      if (selectedSetting.value === undefined || selectedCatogoryIndex.value === undefined) {\n        back();\n        return <></>;\n      }\n      const s = selectedSetting.value;\n      const control = ref<JSX.Element | string>();\n      getControl(s, (value) => {\n        s.value = value;\n      }).then(res => {\n        control.value = res;\n      });\n      return <DeckerLayout\n        topBar={<BasicTopBar\n          leftSlots={[<NButton\n            text\n            onClick={back}\n          >\n            {t('common.cancel')}\n          </NButton>]}\n          rightSlots={[<NButton\n            text\n            type=\"primary\"\n            onClick={() => {\n              const { key } = s;\n              const selectedCatogorySetting = allSettings.value[selectedCatogoryIndex.value!];\n              const index = selectedCatogorySetting.findIndex(se => se.key === key);\n              selectedCatogorySetting.splice(index, 1, s);\n              allSettings.value.splice(selectedCatogoryIndex.value!, 1, selectedCatogorySetting);\n\n              saveSetting(s).finally(() => {\n                selectedSetting.value = undefined;\n                selectedCatogoryIndex.value = undefined;\n                back();\n              });\n            }}\n          >\n            {t('common.save')}\n          </NButton>]}\n        />}\n      >\n        <div class={styles.control}>\n          <div>{t(s.label)}</div>\n          {/* {getControl(s, (value) => {\n            s.value = value;\n          })} */}\n          {control.value}\n        </div>\n      </DeckerLayout>;\n    };\n\n    const renderSettings = (go: () => void) => (<BasicLayout topBar={\n      <BasicTopBar>\n        <SvgIcon name=\"setting\" /> {t('pages.settings.topbar.title')}\n      </BasicTopBar>\n    }>\n      <h2>{t('pages.settings.topbar.title')}</h2>\n      <ul class={cn(styles.list)}>\n        {allSettings.value.map((settings, index) => {\n          return <div class={cn(styles.catogory)}>\n            {settings.filter(setting => !setting.hidden).map((setting) => {\n              return <li\n                key={setting.key}\n                class={cn(styles.item)}\n                onClick={() => {\n                  if (needOpenDecker(setting)) {\n                    selectedCatogoryIndex.value = index;\n                    selectedSetting.value = deepToRaw(setting);\n                    go();\n                  }\n                }}\n              >\n                <span\n                  class={cn(styles.label)}\n                >{t(setting.label)}</span>\n                <span\n                  class={cn(styles.value)}\n                >\n                  {renderValue(setting, (value) => {\n                    setting.value = value;\n                    saveSetting(setting);\n                  })}\n                </span>\n              </li>;\n            })}\n          </div>;\n        })}\n        <div class={cn(styles.catogory)}>\n          <li class={cn(styles.item)} onClick={() => {\n            dialog.warning({\n              title: t('pages.settings.clearData.confirmDialog.title'),\n              content: t('pages.settings.clearData.confirmDialog.content'),\n              positiveText: t('common.yes'),\n              negativeText: t('common.thinkAgain'),\n              closable: false,\n              maskClosable: false,\n              onPositiveClick() {\n                Promise.all([\n                  db.book.clearAllBooks(),\n                  db.bookcase.clearAllBookcases(),\n                  db.settings.clearAllSettings()\n                ]).then(() => {\n                  message.success(t('pages.settings.clearData.confirmDialog.clearFinished'));\n                  setTimeout(() => {\n                    location.replace('./');\n                  }, 7e2);\n                });\n              }\n            });\n          }}>\n            <span class={cn(styles.label)}>{t('pages.settings.clearData.label')}</span>\n            <span class={cn(styles.value)}></span>\n          </li>\n        </div>\n      </ul>\n    </BasicLayout>);\n\n    return () => <DoubleDeckerContainer\n      class={cn(styles.settings)}\n      maskClosable={false}\n    >\n      {{\n        default: renderSettings,\n        decker: renderSettingControl\n      }}\n    </DoubleDeckerContainer>;\n  }\n});\n"],"names":["_isSlot","s","Object","prototype","toString","call","_isVNode","defineComponent","name","setup","updateSettingMap","useSettingsStore","t","useI18n","useScope","message","useMessage","dialog","useDialog","allSettings","ref","selectedCatogoryIndex","selectedSetting","init","Promise","all","settingCatogory","map","catogory","db","settings","getSettingsByCategory","then","res","value","onMounted","saveSetting","setting","key","updateSettingByKey","success","catch","error","renderSettingControl","back","_slot","_slot2","console","log","undefined","_createVNode","_Fragment","control","getControl","DeckerLayout","BasicTopBar","NButton","default","onClick","selectedCatogorySetting","index","findIndex","se","splice","finally","styles","label","renderSettings","go","BasicLayout","SvgIcon","_createTextVNode","cn","list","filter","hidden","item","needOpenDecker","deepToRaw","renderValue","warning","title","content","positiveText","negativeText","closable","maskClosable","onPositiveClick","book","clearAllBooks","bookcase","clearAllBookcases","clearAllSettings","setTimeout","location","replace","DoubleDeckerContainer","decker"],"mappings":"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"}